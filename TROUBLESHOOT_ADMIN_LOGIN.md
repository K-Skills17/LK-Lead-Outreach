# ðŸ” Troubleshoot Admin Login - "Username or Password Incorrect"

## Quick Diagnosis

Run these scripts in order:

### Step 1: Diagnose the Database

```powershell
.\diagnose-admin-login.ps1 -Email "your-email@example.com" -Password "YourPassword"
```

This will:
- âœ… Check if admin exists in database
- âœ… Validate the password hash format
- âœ… Test if your password matches the hash
- âœ… Generate SQL to fix if needed

### Step 2: Test the Login API

```powershell
.\test-admin-login-api.ps1 -Email "your-email@example.com" -Password "YourPassword"
```

This will:
- âœ… Check if server is running
- âœ… Test the actual login endpoint
- âœ… Show detailed error messages

---

## Common Issues & Fixes

### Issue 1: Password Hash Doesn't Match

**Symptoms:**
- Admin exists in database
- `diagnose-admin-login.ps1` shows "PASSWORD DOES NOT MATCH"

**Fix:**
The script will generate SQL to update the password. Or use:

```powershell
.\create-admin.ps1 -Email "your-email@example.com" -Password "YourPassword"
```

This uses the API endpoint which ensures correct hashing.

---

### Issue 2: Email Case Mismatch

**Symptoms:**
- Database has `Admin@Example.com`
- You're logging in with `admin@example.com`

**Fix:**
The login code does `.toLowerCase().trim()`, so this shouldn't be an issue. But verify:

```sql
-- Check exact email in database
SELECT email, name FROM admin_users;
```

Make sure you're using the exact email (case doesn't matter, but check for typos).

---

### Issue 3: Environment Variables Not Loaded

**Symptoms:**
- Server logs show "Missing SUPABASE_SERVICE_ROLE_KEY"
- Login returns 500 error

**Fix:**
1. Check `.env.local` exists and has:
   ```
   SUPABASE_URL=your-url
   SUPABASE_SERVICE_ROLE_KEY=your-key
   ```

2. **Restart the Next.js server** after changing `.env.local`:
   ```powershell
   # Stop the server (Ctrl+C)
   # Then restart:
   npm run dev
   ```

---

### Issue 4: Password Hash is NULL or Corrupted

**Symptoms:**
- `diagnose-admin-login.ps1` shows "Password hash is NULL"

**Fix:**
Run the SQL generated by the diagnostic script, or:

```powershell
.\fix-admin-password-minimal.ps1 -Email "your-email@example.com" -Password "YourPassword"
```

---

### Issue 5: Server Not Running

**Symptoms:**
- `test-admin-login-api.ps1` shows "Server is not running"

**Fix:**
```powershell
npm run dev
```

Wait for "Ready in X seconds" message before testing.

---

## Check Server Logs

When you try to login, check the terminal where `npm run dev` is running. You should see:

```
[Admin Login] Starting login process...
[Admin Login] Login attempt for: your-email@example.com
[Admin Login] Querying database for user...
[Admin Login] User found, verifying password...
[Admin Login] Password valid: true/false
```

**If you see `Password valid: false`:**
- The hash in database doesn't match your password
- Run `diagnose-admin-login.ps1` to fix it

**If you see "User not found":**
- Check the email in database
- Verify email is being lowercased correctly

**If you see "Database error":**
- Check Supabase credentials in `.env.local`
- Verify Supabase project is active

---

## Manual SQL Fix

If all else fails, manually update the password:

1. **Generate hash:**
```powershell
node -e "const bcrypt = require('bcryptjs'); bcrypt.hash('YourPassword', 10).then(h => console.log(h));"
```

2. **Copy the hash** (starts with `$2a$` or `$2b$`)

3. **Run in Supabase SQL Editor:**
```sql
UPDATE admin_users 
SET password_hash = 'PASTE_HASH_HERE'
WHERE email = 'your-email@example.com';

-- Verify
SELECT email, LEFT(password_hash, 15) as hash_preview
FROM admin_users
WHERE email = 'your-email@example.com';
```

---

## Still Not Working?

1. âœ… Run `diagnose-admin-login.ps1` and share the output
2. âœ… Run `test-admin-login-api.ps1` and share the error
3. âœ… Check server logs (terminal output)
4. âœ… Verify `.env.local` has correct Supabase credentials
5. âœ… Make sure server was restarted after changing `.env.local`

---

## Quick Test Checklist

- [ ] Admin user exists in Supabase `admin_users` table
- [ ] `password_hash` column has a value (not NULL)
- [ ] Hash starts with `$2a$10$` or `$2b$10$`
- [ ] `.env.local` has `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY`
- [ ] Next.js server is running (`npm run dev`)
- [ ] Server was restarted after changing `.env.local`
- [ ] Email matches (case-insensitive, but check for typos)
- [ ] Password matches what was used to create the hash
